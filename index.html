<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANIMO</title>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:#fff}
header{padding:14px;background:#020617;text-align:center;font-size:22px;font-weight:bold}
.container{padding:14px}
input,button{width:100%;padding:10px;margin:6px 0;border:none;border-radius:6px}
button{background:#6366f1;color:#fff;font-weight:bold}
.card{background:#111827;padding:10px;border-radius:8px;margin-bottom:10px}
.card img{width:100%;border-radius:6px}
.hidden{display:none}
.admin{background:#020617;padding:12px;border-radius:8px}
.small{font-size:12px;opacity:.7}
.ad{background:#1f2937;text-align:center;padding:10px;border-radius:6px;margin:10px 0}
.back{background:#334155}
</style>
</head>

<body>

<header>ANIMO</header>

<div class="container">

<div id="offline" class="card hidden">⚠️ No Internet Connection</div>

<input id="search" placeholder="Search anime...">

<div id="home"></div>

<div id="details" class="hidden"></div>

<div id="adminBox" class="hidden admin">
  <h3>Admin Panel</h3>
  <input id="adminPass" placeholder="Admin Password">
  <button onclick="loginAdmin()">Login</button>

  <div id="adminPanel" class="hidden">
    <hr>
    <input id="aTitle" placeholder="Anime Title">
    <input id="aImage" placeholder="Poster Image URL">
    <button onclick="addAnime()">Add Anime</button>
    <div id="adminList"></div>
  </div>
</div>

<button onclick="toggleAdmin()">Admin</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, doc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyDRDsqBFjIXp6mh8LO431Usd-Rmpw5pTDM",
  authDomain:"animo-ab129.firebaseapp.com",
  projectId:"animo-ab129"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const home=document.getElementById("home");
const details=document.getElementById("details");
const adminBox=document.getElementById("adminBox");
const adminPanel=document.getElementById("adminPanel");

let animeCache=[];
let admin=false;

window.toggleAdmin=()=>adminBox.classList.toggle("hidden");

window.loginAdmin=()=>{
  if(adminPass.value==="1234"){
    admin=true;
    adminPanel.classList.remove("hidden");
    loadAdmin();
  }else alert("Wrong password");
};

async function loadHome(){
  home.innerHTML="";
  animeCache=[];
  const snap=await getDocs(collection(db,"anime"));
  snap.forEach(d=>{
    animeCache.push({id:d.id,...d.data()});
  });
  renderHome(animeCache);
}

function renderHome(list){
  home.innerHTML="";
  list.forEach(a=>{
    home.innerHTML+=`
    <div class="card" onclick="openAnime('${a.id}')">
      <img src="${a.image}">
      <b>${a.title}</b>
    </div>`;
  });
}

search.oninput=()=>{
  const q=search.value.toLowerCase();
  renderHome(animeCache.filter(a=>a.title.toLowerCase().includes(q)));
};

window.openAnime=async(id)=>{
  const a=animeCache.find(x=>x.id===id);
  details.classList.remove("hidden");
  home.classList.add("hidden");
  details.innerHTML=`<button class="back" onclick="goBack()">⬅ Back</button><h2>${a.title}</h2>`;
  const ss=await getDocs(collection(db,"anime",id,"seasons"));
  ss.forEach(s=>{
    details.innerHTML+=`<h3>${s.data().name}</h3><div id="s${s.id}"></div>`;
    loadEpisodes(id,s.id);
  });
};

window.goBack=()=>{
  details.classList.add("hidden");
  home.classList.remove("hidden");
};

async function loadEpisodes(aid,sid){
  const box=document.getElementById("s"+sid);
  const eps=await getDocs(collection(db,"anime",aid,"seasons",sid,"episodes"));
  eps.forEach(e=>{
    const d=e.data();
    box.innerHTML+=`
    <div class="card">
      ▶ ${d.title}
      <video controls width="100%" src="${d.video}"></video>
    </div>`;
    trackWatch(aid);
  });
}

async function trackWatch(aid){
  await updateDoc(doc(db,"anime",aid),{views:increment(1)});
}

async function loadAdmin(){
  adminList.innerHTML="";
  animeCache.forEach(a=>{
    adminList.innerHTML+=`
    <div class="card">
      <b>${a.title}</b>
      <button onclick="addSeason('${a.id}')">Add Season</button>
      <button onclick="delAnime('${a.id}')">Delete</button>
    </div>`;
  });
}

window.addAnime=async()=>{
  if(!aTitle.value||!aImage.value)return;
  await addDoc(collection(db,"anime"),{
    title:aTitle.value,image:aImage.value,views:0
  });
  aTitle.value="";aImage.value="";
  loadHome();loadAdmin();
};

window.delAnime=async(id)=>{
  if(confirm("Delete anime?")){
    await deleteDoc(doc(db,"anime",id));
    loadHome();loadAdmin();
  }
};

window.addSeason=async(id)=>{
  const n=prompt("Season name");
  if(n)await addDoc(collection(db,"anime",id,"seasons"),{name:n});
};

if(!navigator.onLine){
  document.getElementById("offline").classList.remove("hidden");
}

loadHome();
</script>

</body>
</html>